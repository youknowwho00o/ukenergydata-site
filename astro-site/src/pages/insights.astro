---
import Layout from "../layouts/Layout.astro";
import fs from "fs";
import path from "path";

// ğŸ“ æ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶å¤¹
const reportsDir = path.resolve("src/content/reports");
let latestReport = null;

// ğŸ“„ è¯»å–æœ€æ–° JSON æ–‡ä»¶
try {
  const files = fs.readdirSync(reportsDir).filter(f => f.endsWith(".json"));
  if (files.length > 0) {
    // æŒ‰æ–‡ä»¶åæ’åºï¼ˆæ—¥æœŸæ ¼å¼ï¼‰ï¼Œå–æœ€æ–°ä¸€ä»½
    const latestFile = files.sort().reverse()[0];
    const filePath = path.join(reportsDir, latestFile);
    latestReport = JSON.parse(fs.readFileSync(filePath, "utf-8"));
  }
} catch (err) {
  console.error("è¯»å–æŠ¥å‘Šæ–‡ä»¶å‡ºé”™ï¼š", err);
}
---

<Layout title="Insights | UK Energy Data Dashboard">
  <main class="max-w-5xl mx-auto p-6 space-y-8">

    <!-- AI Summary -->
    <section class="bg-[#0a172f] rounded-2xl p-6 shadow-xl">
      <h1 class="text-3xl font-semibold text-sky-300 mb-4">ğŸ” Market Insights</h1>

      {latestReport ? (
        <article class="bg-[#112240] border border-sky-800 rounded-xl p-6 space-y-4">
          <h2 class="text-xl font-semibold text-sky-400">AI Daily Summary</h2>
          <p class="text-gray-300 leading-relaxed">{latestReport.summary}</p>
          <p class="text-gray-400 text-sm italic">
            Updated: {latestReport.date}
          </p>

          <div class="grid grid-cols-2 gap-6 text-center mt-4">
            <div class="bg-[#112240] p-6 rounded-xl border border-sky-700">
              <h3 class="text-sky-300 font-semibold mb-2">Electricity</h3>
              <p class="text-3xl font-bold text-sky-400">{latestReport.electricity}</p>
              <p class="text-gray-400 text-sm">p/kWh</p>
            </div>
            <div class="bg-[#112240] p-6 rounded-xl border border-sky-700">
              <h3 class="text-sky-300 font-semibold mb-2">Gas</h3>
              <p class="text-3xl font-bold text-sky-400">{latestReport.gas}</p>
              <p class="text-gray-400 text-sm">p/kWh</p>
            </div>
          </div>
        </article>
      ) : (
        <p class="text-gray-400">No reports found. Please check back later.</p>
      )}
    </section>

    <!-- Trend Chart -->
    <section class="bg-[#0a172f] rounded-2xl p-6 shadow-xl">
      <h2 class="text-2xl font-semibold text-sky-300 mb-4">ğŸ“ˆ 7-Day Trend Overview</h2>
      <canvas id="trendChart" height="120"></canvas>
    </section>

    <!-- Context Info -->
    <section class="bg-[#0a172f] rounded-2xl p-6 shadow-xl">
      <h2 class="text-2xl font-semibold text-sky-300 mb-4">ğŸ“˜ About These Insights</h2>
      <p class="text-gray-400 leading-relaxed">
        The AI summaries and data shown here are generated from verified Ofgem and wholesale market sources.
        Updates occur automatically every 24 hours, with data stored under <code>src/content/reports/</code>.
      </p>
    </section>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('trendChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [
            {
              label: 'Electricity (p/kWh)',
              data: [25.7, 25.8, 25.9, 26.1, 25.6, 25.5, 25.7],
              borderColor: 'rgba(56,189,248,0.9)',
              backgroundColor: 'rgba(56,189,248,0.3)',
              fill: true,
              tension: 0.3,
            },
            {
              label: 'Gas (p/kWh)',
              data: [6.3, 6.4, 6.2, 6.5, 6.4, 6.3, 6.3],
              borderColor: 'rgba(251,146,60,0.9)',
              backgroundColor: 'rgba(251,146,60,0.3)',
              fill: true,
              tension: 0.3,
            },
          ],
        },
        options: {
          plugins: { legend: { labels: { color: '#d1d5db' } } },
          scales: {
            x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
            y: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
          },
        },
      });
    }
  </script>
</Layout>
